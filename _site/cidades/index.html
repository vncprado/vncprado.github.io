<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Casos de COVID-19 por cidade no Brasil</title>
<style>
*.hidden {
  display: none !important;
}

div.loading{
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(16, 16, 16, 0.5);
}

@-webkit-keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-webkit-keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-moz-keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-ms-keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-moz-keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-webkit-keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@-o-keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
@keyframes uil-ring-anim {
  0% {
    -ms-transform: rotate(0deg);
    -moz-transform: rotate(0deg);
    -webkit-transform: rotate(0deg);
    -o-transform: rotate(0deg);
    transform: rotate(0deg);
  }
  100% {
    -ms-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    transform: rotate(360deg);
  }
}
.uil-ring-css {
  margin: auto;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  width: 200px;
  height: 200px;
}
.uil-ring-css > div {
  position: absolute;
  display: block;
  width: 160px;
  height: 160px;
  top: 20px;
  left: 20px;
  border-radius: 80px;
  box-shadow: 0 6px 0 0 #ffffff;
  -ms-animation: uil-ring-anim 1s linear infinite;
  -moz-animation: uil-ring-anim 1s linear infinite;
  -webkit-animation: uil-ring-anim 1s linear infinite;
  -o-animation: uil-ring-anim 1s linear infinite;
  animation: uil-ring-anim 1s linear infinite;
}

.select-css {
	display: block;
	font-size: 16px;
	font-family: sans-serif;
	font-weight: 700;
	color: #444;
	line-height: 1.3;
	padding: .6em 1.4em .5em .8em;
	width: 100%;
	max-width: 100%;
	box-sizing: border-box;
	margin: 0;
	border: 1px solid #aaa;
	box-shadow: 0 1px 0 1px rgba(0,0,0,.04);
	border-radius: .5em;
	-moz-appearance: none;
	-webkit-appearance: none;
	appearance: none;
	background-color: #fff;
	background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E'),
	  linear-gradient(to bottom, #ffffff 0%,#e5e5e5 100%);
	background-repeat: no-repeat, repeat;
	background-position: right .7em top 50%, 0 0;
	background-size: .65em auto, 100%;
}
.select-css::-ms-expand {
	display: none;
}
.select-css:hover {
	border-color: #888;
}
.select-css:focus {
	border-color: #aaa;
	box-shadow: 0 0 1px 3px rgba(59, 153, 252, .7);
	box-shadow: 0 0 0 3px -moz-mac-focusring;
	color: #222;
	outline: none;
}
.select-css option {
	font-weight:normal;
}
.button {
  background-color: #000080; /* Green */
  border: none;
  color: white;
  padding: 15px 32px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 0 auto;
}
</style>
<script type="text/javascript" src="https://canvasjs.com/assets/script/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
<script type="text/javascript">
window.onload = function() {

  const selectStates = document.querySelector('#states');
  const selectCities = document.querySelector('#cities');

  function populateStateSelect() {
  	fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados')
  		.then(res => res.json())
  		.then(states => {
  			states.map(state => {
  				const option = document.createElement('option');

  				option.setAttribute('value', state.id);
  				option.textContent = state.sigla;

  				selectStates.appendChild(option);
  			});
  		})
  }

  function populateCitySelect() {
  	selectStates.addEventListener('change', () => {

  		let nodesSelectCities = selectCities.childNodes;

  		[...nodesSelectCities].map(node => node.remove());

  		let state = selectStates.options[selectStates.selectedIndex].value;

  		fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${state}/municipios`)
  			.then(res => res.json())
  			.then(cities => {

  				selectCities.removeAttribute('disabled');

  				cities.map(city => {

  					const option = document.createElement('option');

  					option.textContent = city.nome;

  					selectCities.appendChild(option);
  				});
  			})
  	});
  }
  populateStateSelect();
  populateCitySelect();




    var dataset_novos = [];
    var dataset_confr = [];
    var first_address_novos = "https://brasil.io/api/dataset/covid19/caso_full/data/?format=json&page=1";
    var first_address_confr = "https://brasil.io/api/dataset/covid19/caso/data/?format=json&page=1";

    function recursively_ajax(next, dataset) {
      $.ajax({
        url: next,
        async: false,
        success: function(data){
          next = data.next;
          // var results = data.results;
          if(next!=null) {
            dataset.push(data.results);
            recursively_ajax(next, dataset);
          } else {
            dataset.push(data.results);
            selectStates.removeAttribute('disabled');
          }
      }});
      return true;
    }
    var novos_ok = false
    novos_ok = recursively_ajax(first_address_novos, dataset_novos);
    var confr_ok = false;
    confr_ok = recursively_ajax(first_address_confr, dataset_confr);

    var loadingOverlay = document.querySelector('.loading');
    if(novos_ok == true && confr_ok == true) {
      if (loadingOverlay.classList.contains('hidden')){
        loadingOverlay.classList.remove('hidden');
      } else {
        loadingOverlay.classList.add('hidden');
      }
    }
    else {
      if (loadingOverlay.classList.contains('hidden')){
        loadingOverlay.classList.remove('hidden');
      } else {
        loadingOverlay.classList.add('hidden');
      }
      alert("Dataset load fail, reload the page!");
    }
    const goButton = document.querySelector('#go');
    function collectData() {
      selectCities.addEventListener('change', () => {
        goButton.removeAttribute('disabled');
      });
      goButton.addEventListener('click', () => {
        var state = $('#states :selected').text();
        var city = $('#cities :selected').text();
        // alert(city + " - " + state);

        // Retrieving data novos from a city
        var city_samples_novos = [];
        // alert(dataset_novos.length);
        for(pag=0; pag<dataset_novos.length; pag++) {
          var results_pag = dataset_novos[pag];
          for(i=0; i<results_pag.length; i++) {
            var sample = results_pag[i];
            if(sample.city == city && sample.state == state && sample.place_type == "city") {
              city_samples_novos.push(sample);
            }
          }
        }

        var dataPoints_novos = [];
        for(i=0; i<city_samples_novos.length; i++) {
          dataPoints_novos.push({
              x: new Date(city_samples_novos[i].date),
              y: parseFloat(city_samples_novos[i].new_confirmed)
          });
        }

        var chart_novos = new CanvasJS.Chart("chartContainerNovos", {
          animationEnabled: true,
  		    title: {
  		         text: "Novos Casos " + city,
  		    },
  		    data: [{
               type: "column",
               color: "#014D65",
  		         dataPoints: dataPoints_novos
  		      }]
  	     });

        // Retrieving data confirmados from a city
        var city_samples_confr = [];
        // alert(dataset_novos.length);
        for(pag=0; pag<dataset_confr.length; pag++) {
          var results_pag = dataset_confr[pag];
          for(i=0; i<results_pag.length; i++) {
            var sample = results_pag[i];
            if(sample.city == city && sample.state == state && sample.place_type == "city") {
              city_samples_confr.push(sample);
            }
          }
        }

        var dataPoints_confr = [];
        for(i=0; i<city_samples_confr.length; i++) {
          dataPoints_confr.push({
              x: new Date(city_samples_confr[i].date),
              y: parseFloat(city_samples_confr[i].confirmed)
          });
        }

         var chart_confr = new CanvasJS.Chart("chartContainerConfirmados", {
           animationEnabled: true,
   		    title: {
   		         text: "Casos Confirmados " + city,
   		    },
   		    data: [{
                type: "line",
   		         dataPoints: dataPoints_confr
   		      }]
   	     });

  	     chart_novos.render();
   	     chart_confr.render();
  })
  }
  collectData();
}
</script>
</head>
<body>
  <div class="loading">
    <div class='uil-ring-css' style='transform:scale(0.79);'>
      <div></div>
    </div>
  </div>

  <div id="formContainer" style="width:100%; text-align: center;">
  <select class="select-css" id="states" disabled>
    <option value="">Selecione um estado</option>
  </select>

  <select class="select-css" id="cities" disabled>
    <option value="">Por favor, selecione um estado</option>
  </select>
  <button class="button" type="button" id="go" disabled>Gerar Gráfico</button>
</div>

  <div id="chartContainerConfirmados" style="width:100%; height:300px;"></div>
	<div id="chartContainerNovos" style="width:100%; height:300px;"></div>
  <hr/>
  Página criada para gerar algumas vizualizações do número de casos de COVID-19 em cidade brasileiras.<br/>
  Os dados apresentados aqui são retirados de <a href="https://data.brasil.io/dataset/covid19/_meta/list.html">Brasil.io</a>
</body>
</html>
